# Dataset & Analysis Data

This directory contains:

## Files

### `analysis_scores.json`
Central index of all analyzed houses with their scores. Updated automatically after each analysis.

**Structure:**
```json
{
  "last_updated": "2025-11-09T19:48:37Z",
  "houses": {
    "43132761": {
      "score": 6.88,
      "analyzed_at": "2025-11-08T22:46:04Z",
      "rules_version": "v2.0.0"
    }
  }
}
```

**Used by:**
- Frontend: Fast lookup with ETAG caching
- Updated by: analyze_house.yml workflow

### `apify_dataset.json.gz`
Compressed Apify dataset with all property listings (~30MB compressed, ~140MB uncompressed).

**Generated by:** sync_apify_dataset.yml workflow
**Used by:**
- analyze_house.yml: Decompresses for analysis
- Frontend: Loads and decompresses with pako.js

## Apify Webhook Setup

To automatically sync the dataset when Apify updates:

### Webhook Configuration

**URL:**
```
https://api.github.com/repos/Saltbeef/frontend/dispatches
```

**Method:** `POST`

**Headers:** (as JSON)
```json
{
  "Accept": "application/vnd.github+json",
  "Authorization": "Bearer YOUR_GITHUB_TOKEN",
  "X-GitHub-Api-Version": "2022-11-28",
  "Content-Type": "application/json"
}
```

**Payload Body:**
```json
{
  "event_type": "apify_dataset_updated"
}
```

### GitHub Token Requirements

Create a Personal Access Token with:
- `repo` scope (full control)
- Or: `public_repo` + `workflow` for public repos

**Get token:** https://github.com/settings/tokens

### Apify Setup

1. Go to your Apify Actor/Task ‚Üí **Integrations** or **Webhooks**
2. Add webhook with event type: **"Run succeeded"**
3. Paste URL, headers, and payload from above
4. Replace `YOUR_GITHUB_TOKEN` with actual token
5. Test webhook

### Manual Sync

You can also manually trigger:
- GitHub Actions ‚Üí "Sync Apify Dataset" ‚Üí "Run workflow"
- Or: `gh workflow run sync_apify_dataset.yml`

### Automatic Backup

The workflow runs every 6 hours as backup (cron: `0 */6 * * *`)

## Frontend Usage

**Load compressed dataset:**
```
üåê Load from URL ‚Üí Use default or paste:
https://raw.githubusercontent.com/Saltbeef/frontend/main/data/apify_dataset.json.gz
```

The frontend automatically:
- Detects `.gz` extension
- Downloads as binary (ArrayBuffer)
- Decompresses with pako.inflate
- Caches in IndexedDB
- Uses ETag for efficient updates

**Benefits:**
- 78% smaller download (30MB vs 140MB)
- Browser caching with ETag (304 Not Modified)
- Offline support via IndexedDB
- Fast subsequent loads

## Workflow Diagram

```
Apify Dataset Update
       ‚Üì
Apify Webhook (optional)
       ‚Üì
sync_apify_dataset.yml
       ‚Üì
Downloads dataset ‚Üí Compresses with gzip ‚Üí Commits to git
       ‚Üì
data/apify_dataset.json.gz (in GitHub)
       ‚Üì
‚îú‚îÄ‚Üí analyze_house.yml: gunzip ‚Üí analyze
‚îî‚îÄ‚Üí Frontend: fetch ‚Üí pako.inflate ‚Üí display
```
