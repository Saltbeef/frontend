name: Sync Apify Dataset

on:
  repository_dispatch:
    types: [apify_dataset_updated]
  workflow_dispatch:  # Manual trigger for testing
  schedule:
    # Run every 6 hours as backup
    - cron: '0 */6 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download and compress Apify dataset
        id: download
        env:
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
        run: |
          DATASET_ID="Yb4fTMJ9wQsuyZf3L"

          echo "Downloading dataset ${DATASET_ID}..."

          # Download dataset as JSON
          curl -s "https://api.apify.com/v2/datasets/${DATASET_ID}/items?token=${APIFY_API_TOKEN}&format=json&clean=true" \
            -o data/apify_dataset.json

          # Check if file was downloaded successfully
          if [ ! -s data/apify_dataset.json ]; then
            echo "Error: Failed to download dataset or file is empty"
            exit 1
          fi

          # Get dataset info before compression
          ITEM_COUNT=$(jq 'length' data/apify_dataset.json)
          UNCOMPRESSED_SIZE=$(du -h data/apify_dataset.json | cut -f1)
          echo "Downloaded ${ITEM_COUNT} items (${UNCOMPRESSED_SIZE})"

          # Compress with gzip
          gzip -9 data/apify_dataset.json
          COMPRESSED_SIZE=$(du -h data/apify_dataset.json.gz | cut -f1)
          echo "Compressed to ${COMPRESSED_SIZE}"

          # Output for commit message
          echo "item_count=${ITEM_COUNT}" >> $GITHUB_OUTPUT
          echo "uncompressed_size=${UNCOMPRESSED_SIZE}" >> $GITHUB_OUTPUT
          echo "compressed_size=${COMPRESSED_SIZE}" >> $GITHUB_OUTPUT

      - name: Commit and push if changed
        run: |
          git config user.name "Apify Sync Bot"
          git config user.email "bot@github-actions"

          git add data/apify_dataset.json.gz

          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "âœ… Dataset is up to date"
          else
            ITEM_COUNT="${{ steps.download.outputs.item_count }}"
            UNCOMPRESSED="${{ steps.download.outputs.uncompressed_size }}"
            COMPRESSED="${{ steps.download.outputs.compressed_size }}"

            git commit -m "Sync Apify dataset (${ITEM_COUNT} items, ${UNCOMPRESSED} â†’ ${COMPRESSED})" \
              -m "Updated compressed dataset from Apify datasource Yb4fTMJ9wQsuyZf3L" \
              -m "ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)" \
              -m "Co-Authored-By: Claude <noreply@anthropic.com>"

            git push origin main
            echo "âœ… Dataset updated and pushed"
          fi
